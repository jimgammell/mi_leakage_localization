import numpy as np

from utils.template_attack import TemplateAttack

def evaluate_template_attack_exploitability(profiling_dataset, attack_dataset, leakage_assessment, poi_count=20, target_keys=['subbytes'], target_byte=None):
    points_of_interest = leakage_assessment.squeeze().argsort()[-poi_count:]
    for target_key in target_keys:
        template_attack = TemplateAttack(points_of_interest, target_key=target_key, target_byte=target_byte)
        template_attack.profile(profiling_dataset)
        rank_over_time = template_attack.attack(attack_dataset)
    return rank_over_time

def plot_rank_over_time(rank_over_time, ax, plot_kwargs={}):
    ax.plot(np.median(rank_over_time, axis=0), linestyle='-', **plot_kwargs)
    ax.fill_between(np.arange(rank_over_time.shape[-1]), rank_over_time.min(axis=0), rank_over_time.max(axis=0), alpha=0.25, **plot_kwargs)